# 보안 우려 사항 및 해결 방안

## 🔴 심각한 보안 문제

### 1. **NoSQL 인젝션 (NoSQL Injection)**
**문제**: MongoDB 쿼리에 사용자 입력이 직접 사용될 수 있음
**위험**: 
- `User.findOne({ username })` - Joi로 검증되지만 주의 필요
- URL 파라미터로 받는 ID들이 ObjectId로 변환되지만, 쿼리 객체 조작 가능

**예시 공격**:
```javascript
// 로그인 시
POST /api/auth/login
{ "username": { "$ne": null }, "password": { "$ne": null } }
// 모든 사용자와 매칭될 수 있음
```

**해결책**:
- Joi 검증으로 문자열만 허용 (현재 부분적으로 적용됨)
- Mongoose의 타입 체크 활용
- ObjectId 검증 강화

---

### 2. **Rate Limiting 부재 (브루트포스 공격)**
**문제**: 로그인, 회원가입 등에 요청 제한이 없음
**위험**:
- 무제한 로그인 시도로 계정 탈취 시도
- 회원가입 스팸
- API 남용

**해결책**:
- `express-rate-limit` 패키지 사용
- IP별, 사용자별 요청 제한

---

### 3. **CORS 미설정**
**문제**: 모든 도메인에서 API 접근 가능
**위험**: 
- CSRF 공격 가능
- 무단 API 사용

**해결책**:
- `cors` 패키지로 허용된 도메인만 설정

---

### 4. **보안 헤더 부재**
**문제**: 기본 보안 헤더가 설정되지 않음
**위험**:
- XSS 공격
- 클릭재킹
- MIME 타입 스니핑

**해결책**:
- `helmet` 패키지 사용

---

### 5. **CSRF 보호 부재**
**문제**: 세션 기반 인증인데 CSRF 토큰 없음
**위험**: 
- 악의적인 사이트에서 사용자 대신 요청 실행

**해결책**:
- `csurf` 또는 `csrf` 패키지 사용
- SameSite 쿠키 설정 (일부 적용됨)

---

## 🟡 중간 수준 보안 문제

### 6. **에러 메시지 정보 노출**
**문제**: 상세한 에러 정보가 클라이언트에 노출됨
**위험**:
- 시스템 구조 파악 가능
- 디버깅 정보 노출

**예시**:
```javascript
console.error('회원가입 오류:', error); // 스택 트레이스 노출 가능
```

**해결책**:
- 프로덕션 환경에서는 일반적인 에러 메시지만 반환
- 상세 에러는 로그에만 기록

---

### 7. **비밀번호 정책 약함**
**문제**: 최소 6자만 요구
**위험**:
- 약한 비밀번호 허용

**해결책**:
- 최소 8자, 대소문자, 숫자, 특수문자 조합 요구
- 또는 최소 복잡도 점수 요구

---

### 8. **세션 보안 개선 필요**
**현재 설정**:
- `httpOnly: true` ✅
- `secure: production에서만` ✅
- `maxAge: 24시간` ⚠️

**개선 사항**:
- SameSite 쿠키 설정
- 세션 갱신 로직
- 세션 고정 공격 방지

---

### 9. **ObjectId 검증 부족**
**문제**: URL 파라미터로 받는 ID가 ObjectId 형식인지 검증이 약함
**예시**:
```javascript
// routes/match.js
router.get('/:id', async (req, res) => {
  // CastError로 잡히지만, 더 명시적인 검증 필요
})
```

**해결책**:
- mongoose.Types.ObjectId.isValid() 사용
- 미들웨어로 통합

---

### 10. **XSS (Cross-Site Scripting) 가능성**
**문제**: 사용자 입력이 그대로 저장되고 반환됨
**위험**:
- 스크립트 주입 가능

**현재 상태**:
- Joi의 `.trim()`으로 일부 보호
- 하지만 HTML 태그 등은 필터링 안 됨

**해결책**:
- `xss` 또는 `dompurify` 패키지 사용
- 또는 출력 시 이스케이프

---

### 11. **환경 변수 기본값 노출**
**문제**: 
```javascript
process.env.SESSION_SECRET || 'your-secret-key-change-this'
```
**위험**: 
- 기본값이 코드에 노출됨
- 프로덕션에서 환경 변수 미설정 시 취약

**해결책**:
- 환경 변수 필수 체크
- 기본값 제거

---

### 12. **로그인 실패 메시지 정보 노출**
**현재**:
```javascript
'사용자명 또는 비밀번호가 올바르지 않습니다.'
```
**문제**: 
- 사용자명 존재 여부를 알 수 없어야 함 (현재는 괜찮음)
- 하지만 타이밍 공격 가능성

**개선**:
- 항상 동일한 시간 소요되도록 처리

---

## 🟢 낮은 수준 (개선 권장)

### 13. **입력 길이 제한**
**문제**: 일부 필드에 길이 제한이 없음
**예시**: `nationality`, `contact_method`

**해결책**:
- Joi 스키마에 maxlength 추가

---

### 14. **SQL 인젝션**
**참고**: MongoDB를 사용하므로 SQL 인젝션은 해당 없음
**대신**: NoSQL 인젝션에 주의 (위 1번 참고)

---

### 15. **세션 하이재킹**
**현재 보호**:
- httpOnly 쿠키 ✅
- secure 쿠키 (production) ✅

**추가 보호**:
- IP 주소 검증
- User-Agent 검증
- 세션 갱신

---

## 📋 보안 개선 우선순위

### 높음 (즉시 해결)
1. ✅ Rate Limiting 추가
2. ✅ Helmet.js 추가
3. ✅ CORS 설정
4. ✅ NoSQL 인젝션 방지 강화

### 중간 (빠른 시일 내)
5. ✅ CSRF 보호
6. ✅ 에러 메시지 개선
7. ✅ 환경 변수 검증
8. ✅ ObjectId 검증 미들웨어

### 낮음 (점진적 개선)
9. ✅ 비밀번호 정책 강화
10. ✅ XSS 필터링
11. ✅ 세션 보안 강화
12. ✅ 입력 길이 제한

---

## 🔐 현재 보안 상태 요약

### ✅ 잘 되어 있는 것
- 비밀번호 해싱 (bcrypt, salt rounds 15)
- Joi 입력 검증
- httpOnly 쿠키
- 세션 기반 인증
- Mongoose 타입 체크

### ⚠️ 개선 필요한 것
- Rate Limiting 없음
- CORS 미설정
- 보안 헤더 없음
- CSRF 보호 없음
- 에러 정보 노출
- 환경 변수 기본값

---

## 다음 단계

보안 개선을 위한 패키지 설치 및 코드 수정을 진행할까요?

